name: Generate PDF

on:
  push:
    branches:
      - main
    paths:
      - 'library/**'
      - 'templates/**'
      - 'src/**'
      - '.github/workflows/generate-pdf.yml'

jobs:
  generate-pdf:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: Install LaTeX dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y texlive-xetex texlive-latex-extra texlive-fonts-extra
      
      - name: Install Pygments
        run: pip install pygments
      
      - name: Generate content.tex
        run: |
          # Generate content using Python
          python3 -c "
import sys
from pathlib import Path
sys.path.insert(0, 'src')

import content_generator
import team_info

# Define paths
library_path = Path('library')
templates_dir = Path('templates')
templates_dir.mkdir(exist_ok=True)

# Use default team info for automated builds
team_info_data = {
    'title': 'ICPC World Finals',
    'team_name': 'Team Name',
    'members': ['Member 1', 'Member 2', 'Member 3']
}

# Generate team_info.tex
team_info_path = templates_dir / 'team_info.tex'
team_info.generate_team_info_tex(team_info_data, team_info_path)
print(f'âœ“ Generated {team_info_path}')

# Generate content.tex
content_path = templates_dir / 'content.tex'
num_lines = content_generator.generate_content_tex(library_path, content_path)
print(f'âœ“ Generated {content_path} with {num_lines} lines')
"
      
      - name: Compile PDF
        run: |
          cp templates/main.tex .
          xelatex -shell-escape -interaction=nonstopmode -output-directory=output main.tex
          xelatex -shell-escape -interaction=nonstopmode -output-directory=output main.tex
      
      - name: Clean up auxiliary files
        run: |
          rm -f main.aux main.log main.out main.toc main.tex
          find output -type f ! -name '*.pdf' ! -name '*.tex' -delete 2>/dev/null || true
      
      - name: Upload PDF artifact
        uses: actions/upload-artifact@v4
        with:
          name: cp-template-pdf
          path: output/main.pdf
          retention-days: 90
      
      - name: Commit generated PDF (optional)
        if: success()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add output/main.pdf templates/content.tex templates/team_info.tex 2>/dev/null || true
          git diff --staged --quiet || git commit -m "ðŸ¤– Auto-generate PDF [skip ci]"
          git push || echo "No changes to push"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
