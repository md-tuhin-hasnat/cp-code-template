name: Generate PDF

on:
  push:
    branches:
      - main
    paths:
      - 'library/**'
      - 'templates/**'
      - 'src/**'
      - '.github/workflows/generate-pdf.yml'

permissions:
  contents: write

jobs:
  generate-pdf:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: Cache LaTeX packages
        id: cache-latex
        uses: actions/cache@v4
        with:
          path: |
            /usr/share/texlive
            /usr/share/texmf
            ~/.texlive
          key: ${{ runner.os }}-texlive-${{ hashFiles('.github/workflows/generate-pdf.yml') }}
          restore-keys: |
            ${{ runner.os }}-texlive-
      
      - name: Install LaTeX dependencies
        if: steps.cache-latex.outputs.cache-hit != 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y texlive-xetex texlive-latex-extra texlive-fonts-extra
      
      - name: Install Pygments
        run: pip install pygments
      
      - name: Generate content.tex
        run: python3 src/generate_ci.py
      
      - name: Compile PDF
        run: |
          mkdir -p dist
          cp templates/main.tex .
          xelatex -shell-escape -interaction=nonstopmode -output-directory=dist main.tex || true
          xelatex -shell-escape -interaction=nonstopmode -output-directory=dist main.tex || true
          # Check if PDF was actually created
          if [ ! -f dist/main.pdf ]; then
            echo "Error: PDF was not generated"
            exit 1
          fi
          echo "PDF generated successfully"
      
      - name: Clean up auxiliary files
        run: |
          rm -f main.aux main.log main.out main.toc main.tex
          find dist -type f ! -name '*.pdf' ! -name '*.tex' -delete 2>/dev/null || true
      
      - name: Upload PDF artifact
        uses: actions/upload-artifact@v4
        with:
          name: cp-template-pdf
          path: dist/main.pdf
          retention-days: 90
      
      - name: Commit generated PDF (optional)
        if: success()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add dist/main.pdf templates/content.tex templates/team_info.tex 2>/dev/null || true
          git diff --staged --quiet || git commit -m "ðŸ¤– Auto-generate PDF [skip ci]"
          git push || echo "No changes to push"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
# This triggers the workflow
